<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donatello Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col items-center min-h-screen p-4">

    <h1 class="text-4xl font-bold mb-8">Donatello Challenge</h1>

    <div id="challenges" class="flex flex-wrap justify-center gap-8">

        <div id="challenge1" class="bg-white p-6 rounded-lg shadow-md flex flex-col items-center">
            <h2 class="text-2xl font-semibold mb-4">Challenge 1</h2>
            <canvas id="canvas1" width="20" height="20" class="border border-gray-300 bg-gray-50 mb-4"></canvas>
            <div id="hashes1" class="text-sm">
                <p>Red: <span id="red-hash1" class="font-mono"></span> (S: <span id="red-hash-server1" class="font-mono"></span>) <span id="red-match1"></span></p>
                <p>Green: <span id="green-hash1" class="font-mono"></span> (S: <span id="green-hash-server1" class="font-mono"></span>) <span id="green-match1"></span></p>
                <p>Blue: <span id="blue-hash1" class="font-mono"></span> (S: <span id="blue-hash-server1" class="font-mono"></span>) <span id="blue-match1"></span></p>
                <p>Alpha: <span id="alpha-hash1" class="font-mono"></span> (S: <span id="alpha-hash-server1" class="font-mono"></span>) <span id="alpha-match1"></span></p>
            </div>
        </div>

        <div id="challenge2" class="bg-white p-6 rounded-lg shadow-md flex flex-col items-center">
            <h2 class="text-2xl font-semibold mb-4">Challenge 2</h2>
            <canvas id="canvas2" width="20" height="20" class="border border-gray-300 bg-gray-50 mb-4"></canvas>
            <div id="hashes2" class="text-sm">
                <p>Red: <span id="red-hash2" class="font-mono"></span></p>
                <p>Green: <span id="green-hash2" class="font-mono"></span></p>
                <p>Blue: <span id="blue-hash2" class="font-mono"></span></p>
                <p>Alpha: <span id="alpha-hash2" class="font-mono"></span></p>
            </div>
        </div>

    </div>

    <button onclick="fetchAndDrawChallenge()" class="mt-8 px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75">
        New Challenge
    </button>

    <p class="mt-4 text-sm text-gray-500">Time taken: <span id="time-taken">N/A</span></p>

    <script>
        function drawRectangle(ctx, color, w, h, x, y) {
            ctx.fillStyle = '#' + color;
            ctx.fillRect(x, y, w, h);
        }

        function drawCircle(ctx, color, r, x, y) {
            ctx.fillStyle = '#' + color;
            ctx.beginPath();
            ctx.arc(x, y, r, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawTriangle(ctx, color, x1, y1, x2, y2, x3, y3) {
            ctx.fillStyle = '#' + color;
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.lineTo(x3, y3);
            ctx.closePath();
            ctx.fill();
        }

        function drawLine(ctx, color, x1, y1, x2, y2, thickness) {
            ctx.strokeStyle = '#' + color;
            ctx.lineWidth = thickness;
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();
        }

        function drawEllipse(ctx, color, rx, ry, x, y) {
            ctx.fillStyle = '#' + color;
            ctx.beginPath();
            ctx.ellipse(x, y, rx, ry, 0, 0, Math.PI * 2);
            ctx.fill();
        }

        async function sha256(uint8Array) {
            const buf = await crypto.subtle.digest("SHA-256", uint8Array);
            return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function drawTask(ctx, taskString) {
            if (!taskString) {
                console.error('No task string received');
                return;
            }
            const shapes = taskString.split(';');
            shapes.forEach(shapeStr => {
                if (!shapeStr) return;
                const parts = shapeStr.split(':');
                const type = parts[0];
                const color = parts[1];

                switch (type) {
                    case 'R':
                        drawRectangle(ctx, color, parseInt(parts[2]), parseInt(parts[3]), parseInt(parts[4]), parseInt(parts[5]));
                        break;
                    case 'C':
                        drawCircle(ctx, color, parseInt(parts[2]), parseInt(parts[3]), parseInt(parts[4]));
                        break;
                    case 'T':
                        drawTriangle(ctx, color, parseInt(parts[2]), parseInt(parts[3]), parseInt(parts[4]), parseInt(parts[5]), parseInt(parts[6]), parseInt(parts[7]));
                        break;
                    case 'L':
                        drawLine(ctx, color, parseInt(parts[2]), parseInt(parts[3]), parseInt(parts[4]), parseInt(parts[5]), parseInt(parts[6]));
                        break;
                    case 'E':
                        drawEllipse(ctx, color, parseInt(parts[2]), parseInt(parts[3]), parseInt(parts[4]), parseInt(parts[5]));
                        break;
                    default:
                        console.warn('Unknown shape type:', type);
                }
            });
        }

        async function calculateAndDisplayHashes(canvas, serverHashes, ids) {
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            const rChannel = new Uint8Array(canvas.width * canvas.height);
            const gChannel = new Uint8Array(canvas.width * canvas.height);
            const bChannel = new Uint8Array(canvas.width * canvas.height);
            const aChannel = new Uint8Array(canvas.width * canvas.height);

            for (let y = 0; y < canvas.height; y++) {
                for (let x = 0; x < canvas.width; x++) {
                    const i = (y * canvas.width + x) * 4;
                    const pixelIndex = y * canvas.width + x;
                    rChannel[pixelIndex] = data[i];
                    gChannel[pixelIndex] = data[i + 1];
                    bChannel[pixelIndex] = data[i + 2];
                    aChannel[pixelIndex] = data[i + 3];
                }
            }

            const clientRedHash = await sha256(rChannel);
            const clientGreenHash = await sha256(gChannel);
            const clientBlueHash = await sha256(bChannel);
            const clientAlphaHash = await sha256(aChannel);

            document.getElementById(ids.red).textContent = clientRedHash;
            document.getElementById(ids.green).textContent = clientGreenHash;
            document.getElementById(ids.blue).textContent = clientBlueHash;
            document.getElementById(ids.alpha).textContent = clientAlphaHash;

            if (Object.keys(serverHashes).length !== 0) {
                document.getElementById(ids.redServer).textContent = serverHashes.red || 'N/A';
                document.getElementById(ids.greenServer).textContent = serverHashes.green || 'N/A';
                document.getElementById(ids.blueServer).textContent = serverHashes.blue || 'N/A';
                document.getElementById(ids.alphaServer).textContent = serverHashes.alpha || 'N/A';

                document.getElementById(ids.redMatch).textContent = serverHashes.red ? (clientRedHash === serverHashes.red ? '✅' : '❌') : '';
                document.getElementById(ids.greenMatch).textContent = serverHashes.green ? (clientGreenHash === serverHashes.green ? '✅' : '❌') : '';
                document.getElementById(ids.blueMatch).textContent = serverHashes.blue ? (clientBlueHash === serverHashes.blue ? '✅' : '❌') : '';
                document.getElementById(ids.alphaMatch).textContent = serverHashes.alpha ? (clientAlphaHash === serverHashes.alpha ? '✅' : '❌') : '';
            }
        }

        async function fetchAndDrawChallenge() {
            const startTime = performance.now();

            const canvas1 = document.getElementById('canvas1');
            const ctx1 = canvas1.getContext('2d', { willReadFrequently: true });
            const canvas2 = document.getElementById('canvas2');
            const ctx2 = canvas2.getContext('2d', { willReadFrequently: true });

            ctx1.clearRect(0, 0, canvas1.width, canvas1.height);
            ctx2.clearRect(0, 0, canvas2.width, canvas2.height);

            try {
                const response = await fetch('/challenge');
                const data = await response.json();

                drawTask(ctx1, data.first_task);
                drawTask(ctx2, data.second_task);

                const ids1 = {
                    red: 'red-hash1', green: 'green-hash1', blue: 'blue-hash1', alpha: 'alpha-hash1',
                    redServer: 'red-hash-server1', greenServer: 'green-hash-server1', blueServer: 'blue-hash-server1', alphaServer: 'alpha-hash-server1',
                    redMatch: 'red-match1', greenMatch: 'green-match1', blueMatch: 'blue-match1', alphaMatch: 'alpha-match1'
                };
                await calculateAndDisplayHashes(canvas1, data.hashes, ids1);

                const ids2 = {
                    red: 'red-hash2', green: 'green-hash2', blue: 'blue-hash2', alpha: 'alpha-hash2',
                    redServer: 'red-hash-server2', greenServer: 'green-hash-server2', blueServer: 'blue-hash-server2', alphaServer: 'alpha-hash-server2',
                    redMatch: 'red-match2', greenMatch: 'green-match2', blueMatch: 'blue-match2', alphaMatch: 'alpha-match2'
                };
                await calculateAndDisplayHashes(canvas2, {}, ids2);

            } catch (error) {
                console.error('Error fetching or drawing challenge:', error);
            } finally {
                const endTime = performance.now();
                const timeTaken = endTime - startTime;
                document.getElementById('time-taken').textContent = `${timeTaken.toFixed(2)} ms`;
            }
        }

        // Fetch and draw a challenge when the page loads
        fetchAndDrawChallenge();
    </script>
</body>
</html>